# Integration Plan: Unify my-opencode into spec-kit's-opencode

Status: Proposed (no code changes applied)
Owner: alperenyagci
Decision Summary:
- Spec‑Kit is the single source of truth
- Use all subagents from my‑opencode
- Preserve thoughts/ workflow: keep a standalone `/research_codebase` command that writes to thoughts/; `/plan` must always refer to relevant thoughts research if present (no migration of legacy content)
- No wrappers or env toggles
 - Produce per‑feature `research.md` (narrative) with strong evidence anchors (file:line)
 - Defaults resolved: analyzer hotspots default `N = 20` (heuristic‑aware), evidence anchors threshold default `5`

## Objectives
- Unify the development workflow under Spec‑Kit commands and guardrails.
- Integrate my‑opencode’s subagent strengths into Spec‑Kit’s planning, analysis, and implementation commands.
 - Preserve thoughts/ as an auxiliary research space referenced by `/plan`.
 - Keep outputs consistent with Spec‑Kit defaults (Markdown artifacts only).

## Scope
- Repository areas touched:
  - `spec-kit's-opencode/.opencode/command/{plan.md, analyze.md, implement.md, research_codebase.md}`
  - `spec-kit's-opencode/.opencode/agent/*` (new)
  - `.specify/scripts/bash/*` (read‑only; keep as control plane)
  - `AGENTS.md` (project‑level memory, optional docs note)
- Out of scope:
  - Migration of existing thoughts/ documents (we keep them as‑is and reference when relevant)
  - Altering Spec‑Kit’s core bash scripts beyond their current behavior
  - Adding wrappers, toggles, or alternate command names

## Deliverables
- New subagent files under `spec-kit's-opencode/.opencode/agent/`:
  - `codebase-locator.md` (copy from `my-opencode/agent/codebase-locator.md`)
  - `codebase-analyzer.md` (copy from `my-opencode/agent/codebase-analyzer.md`)
  - `codebase-pattern-finder.md` (copy from `my-opencode/agent/codebase-pattern-finder.md`)
  - Keep doc agents for thoughts workflow:
    - `thoughts-locator.md` (copy from `my-opencode/agent/thoughts-locator.md`)
    - `thoughts-analyzer.md` (copy from `my-opencode/agent/thoughts-analyzer.md`)
  - Optional: `web-search-researcher.md` (best‑effort, offline‑safe)
- New main command:
  - `research_codebase.md` (copy from `my-opencode/command/research_codebase.md`) — standalone, writes to thoughts/
- Command enhancements:
  - `plan.md`: Phase 0 runs subagents, consults thoughts/ research (if present), writes narrative `research.md` and enforces acceptance gates
  - `analyze.md`: Adds read‑only “source reality check” using live code + research.md evidence; may surface links to related thoughts research (non‑gating)
  - `implement.md`: Derives “Edit Waypoints” via on‑demand analysis; blocks tasks lacking resolvable anchors

## Non‑Goals
- Migrating existing thoughts/ content (we will reference it when relevant)
- Introducing parallel command names or compatibility wrappers
- Changing Spec‑Kit’s `specify → plan → tasks → analyze → implement` flow order

## Agent Mapping
- Code agents (drop‑in):
  - `codebase-locator` → inventory code surfaces and entry points
  - `codebase-analyzer` → trace data flows and call graphs with file:line anchors
  - `codebase-pattern-finder` → surface analogous implementations
- Thoughts agents (for external insights):
  - `thoughts-locator` → discover relevant documents under thoughts/
  - `thoughts-analyzer` → extract decisions, trade‑offs, constraints from thoughts docs
- Optional:
  - `web-search-researcher` used only when network is available or explicitly requested; include citations only

## Research.md Structure
Narrative sections:
- Overview and Scope
- Code Surface Map (entries, modules, key files)
- Data Flow Traces (file:line anchors)
- Similar Implementations/Patterns
- External Insights (thoughts/ research)
  - List and link the most relevant thoughts research documents (esp. generated by `/research_codebase`)
  - Summarize key decisions and constraints; clearly mark non‑gating status
- Risks, Unknowns, Assumptions
- Evidence Index (files and lines referenced)


## Command Enhancements (No wrappers, Spec‑Kit as control plane)

### plan.md — Phase 0: Research & Discovery
Inputs: `.specify/scripts/bash/setup-plan.sh --json` → FEATURE_SPEC, IMPL_PLAN, SPECS_DIR, BRANCH (absolute paths).
Steps:
1) Run `thoughts-locator` to find recent and topic‑relevant research docs under thoughts/ (esp. those produced by `/research_codebase`).
2) Optionally run `thoughts-analyzer` on top K findings to extract decisions, constraints, and links for the “External Insights” section.
3) Run `codebase-locator` to identify code surfaces and plausible entries.
4) Run `codebase-analyzer` (top N surfaces) to extract flows and anchors.
5) Run `codebase-pattern-finder` to list analogous implementations and references.
6) Synthesize narrative sections (including External Insights) and write `specs/<feature>/research.md`.
7) Validate Phase 0 acceptance gates; mark progress in plan.

Phase 0 acceptance gates:
- research.md includes the sections listed above (Surface Map, Data Flows, Risks, Evidence Index)
- Evidence anchors threshold: default 5; or `max(5, ceil(0.5 * entry_surfaces))`
- At least one entry surface and one non‑trivial flow documented
- Prefer anchors distributed across selected hotspots when possible
- If relevant thoughts research exists, include at least one reference link in the “External Insights” section; if none exists, note “No external insights found”

### analyze.md — Read‑Only Reality Check
Inputs: `spec.md`, `plan.md`, `tasks.md`, `research.md` (narrative), constitution.
Checks:
- Terminology/entities across artifacts vs the documented surfaces/flows (validate against live code with subagents)
- File paths in tasks vs actual repo (validate existence via subagents)
- Constitution alignment (keep existing severity rules)
Behavior:
- Report structured findings. If research.md is missing critical sections or has insufficient anchors → raise HIGH/CRITICAL findings with clear remediation.
- Optionally surface a non‑gating “Related thoughts research” subsection with links and deltas from `research.md`

### implement.md — Execution Targeting
Inputs: `.specify/scripts/bash/check-prerequisites.sh --json --require-tasks` + artifacts.
Per task:
- Derive Edit Waypoints on‑demand using `codebase-analyzer` for the target file(s)/symbols
- Use research.md Evidence Index as guidance when present; if anchors cannot be resolved → block with actionable error
Execution:
- Respect phases, dependencies, and [P] parallelism in tasks.md; mark completion by updating tasks file

Defaults used during execution:
- Analyzer hotspot budget: default N = 20; heuristic when available = clamp(8, 40, round(0.02 × total_source_files)); always include files explicitly referenced in spec/plan/tasks
- Re‑anchoring: prefer fresh analysis at HEAD; if research.md anchors drift, recompute and proceed only when confident

### research_codebase — Standalone Research Command
Purpose: Ad‑hoc, subagent‑heavy exploration for complex questions; writes narrative research to thoughts/ (and may embed the same JSON block as a sidecar for reuse).
Location: `spec-kit's-opencode/.opencode/command/research_codebase.md`
Behavior:
- Use `codebase-locator`, `codebase-analyzer`, `codebase-pattern-finder`, and `thoughts-*` agents as orchestrated in your legacy command
- Output to `thoughts/shared/research/YYYY-MM-DD-topic.md` (or user‑scoped)
- Include links and, optionally, a JSON appendix compatible with `research.md` schema for easy import
- `/plan` must always refer to these outputs (if present) in its External Insights section

## Validation & Tooling
- Evidence integrity: verify referenced files exist and line ranges are valid
- Offline behavior: `web-search-researcher` is best‑effort; never blocks gates

## Success Criteria
- `/plan` produces a complete research.md and passes gates
- `/analyze` cross‑checks artifacts with code reality and constitution deterministically
- `/implement` computes Edit Waypoints on‑demand; blocks unsafe edits with clear diagnostics
- Thoughts workflow preserved; `my-opencode/` can be deleted without loss

## Risks & Mitigations
- Large codebases → limit analyzer to top N hotspots (configurable; default N=20)
- Task path inaccuracies → auto‑map using `codebase-locator` and report diffs before blocking
- Network limits → treat web search as optional enrichment only

## Rollout Plan
- Phase A: Add subagents under `.opencode/agent/*` (no behavior change yet)
- Phase B: Enhance `plan.md` to generate `research.md` and enforce gates
- Phase C: Enhance `analyze.md` to perform source reality checks using research.md + live code
- Phase D: Enhance `implement.md` to compute Edit Waypoints on‑demand
- Phase E: Validate on a fresh feature: `/specify` → `/plan` → `/tasks` → `/analyze` → `/implement`
- Phase F: Remove `my-opencode/` after parity confirmed

## Resolved Defaults
- Hotspots: default N = 20; heuristic clamp(8, 40, round(0.02 × total_source_files)); always include explicitly referenced files
- Evidence anchors: default threshold 5; raise to `max(5, ceil(0.5 * entry_surfaces))` when many surfaces selected

---

Appendix: Implementation Checklist
- [ ] Copy subagents to `spec-kit's-opencode/.opencode/agent/` (including thoughts‑locator/analyzer)
- [ ] Update `plan.md` to run subagents and write `research.md` with gates
- [ ] Update `analyze.md` to validate artifacts against code using research.md and live analysis
- [ ] Update `implement.md` to compute Edit Waypoints on‑demand and enforce presence
- [ ] Sanity‑run end‑to‑end on a new feature; confirm gates and reports
- [ ] Delete `my-opencode/` after validation
